[workspace]
name = "pychronotab"
version = "0.1.0"
description = "A modern cron expression iterator with croniter API compatibility"
channels = ["conda-forge"]
platforms = ["osx-arm64", "osx-64", "linux-64", "win-64"]

[dependencies]
python = ">=3.9,<3.14"
pip = "*"
python-build = "*"
hatchling = "*"
hatch-vcs = "*"

[pypi-dependencies]
pychronotab = { path = ".", editable = true }

# Development feature
[feature.dev.dependencies]
pytest = "*"
pytest-cov = "*"
ruff = "*"
mypy = "*"
pre-commit = "*"
twine = "*"
safety = "*"
bandit = "*"
git-cliff = "*"
git = "*"
act = "*"

# Test feature
[feature.test.dependencies]
pytest = "*"
pytest-cov = "*"

# Lint feature
[feature.lint.dependencies]
ruff = "*"
mypy = "*"
bandit = "*"
safety = ">=2.3.5,<3.0"
marshmallow = ">=3.0,<4.0"
typing_extensions = "*"

# Environment definitions
[environments]
default = ["dev"]
test = ["test"]
lint = ["lint"]
dev = ["dev", "test", "lint"]

# Testing tasks
[feature.test.tasks]
test = "pytest"
test-cov = "pytest --cov=pychronotab --cov-report=term-missing --cov-report=html --cov-report=xml tests/"
test-verbose = "pytest -v"

# Linting tasks
[feature.lint.tasks]
lint = "ruff check src/ tests/"
lint-fix = "ruff check --fix src/ tests/"
format = "ruff check --fix --exit-non-zero-on-fix src/ tests/ && ruff format src/ tests/"
format-check = "ruff format --check src/ tests/"
type-check = "mypy src/pychronotab --ignore-missing-imports"
security-check = "bandit -r src/ -c pyproject.toml && safety check --json"
check = { depends-on = ["lint", "type-check"] }
check-all = { depends-on = ["lint", "type-check", "security-check"] }

# Build tasks
[feature.dev.tasks]
clean = "python -c 'import shutil, pathlib; [shutil.rmtree(p, ignore_errors=True) for p in [pathlib.Path(\"build\"), pathlib.Path(\"dist\")] + list(pathlib.Path(\".\").glob(\"*.egg-info\")) + list(pathlib.Path(\".\").glob(\"**/__pycache__\")) + [pathlib.Path(\".pytest_cache\"), pathlib.Path(\".coverage\"), pathlib.Path(\"htmlcov\"), pathlib.Path(\"coverage.xml\")]]'"
build = { cmd = "python -m build", depends-on = ["clean"] }
publish = { cmd = "twine upload dist/*", depends-on = ["build"] }
publish-test = { cmd = "twine upload --repository testpypi dist/*", depends-on = ["build"] }

# Changelog tasks
changelog = "git-cliff --output CHANGELOG.md"
changelog-unreleased = "git-cliff --unreleased --tag unreleased --output -"
changelog-latest = "git-cliff --latest --output -"
release-preview = "git-cliff --bump --unreleased --output -"

# Pre-commit tasks
pre-commit-install = "pre-commit install && pre-commit install --hook-type commit-msg"
pre-commit-run = "pre-commit run --all-files"

# GitHub Actions local testing with act
act-setup = "echo 'Updating .actrc and .secrets files for act configuration...' && touch .actrc .secrets && grep -qxF -- '--container-architecture linux/amd64' .actrc || echo '--container-architecture linux/amd64' >> .actrc && grep -qxF -- '--secret-file .secrets' .actrc || echo '--secret-file .secrets' >> .actrc && grep -qxF -- '-P ubuntu-latest=catthehacker/ubuntu:act-latest' .actrc || echo '-P ubuntu-latest=catthehacker/ubuntu:act-latest' >> .actrc && grep -qxF 'GITHUB_TOKEN=dummy' .secrets || echo 'GITHUB_TOKEN=dummy' >> .secrets && grep -qxF 'RELEASE_PAT=dummy' .secrets || echo 'RELEASE_PAT=dummy' >> .secrets && grep -qxF 'TEST_PYPI_API_TOKEN=dummy' .secrets || echo 'TEST_PYPI_API_TOKEN=dummy' >> .secrets && grep -qxF 'PYPI_API_TOKEN=dummy' .secrets || echo 'PYPI_API_TOKEN=dummy' >> .secrets && echo 'âœ… Act setup complete! Edit .secrets with real tokens if needed.'"
act = "act"
act-list = "act -l"
act-dryrun = "act --dryrun"
act-ci = "act push -W .github/workflows/ci.yml"
act-pr = "act pull_request -W .github/workflows/ci.yml"
act-release = "act workflow_dispatch -W .github/workflows/release.yml --input version=0.99.0-test --input prerelease=true"
act-publish = "act release -W .github/workflows/publish.yml"
act-maintenance = "act schedule -W .github/workflows/maintenance.yml"
act-quality-monitoring = "act schedule -W .github/workflows/quality-monitoring.yml"
act-sonarqube = "act push -W .github/workflows/sonarqube.yml"
act-stale = "act schedule -W .github/workflows/stale.yml"

# Combined tasks
ci = { depends-on = ["check-all", "test-cov", "build"] }

# Development setup
dev-setup = { depends-on = ["pre-commit-install"] }
